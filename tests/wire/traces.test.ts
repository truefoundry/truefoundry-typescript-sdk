// This file was auto-generated by Fern from our API Definition.

import { TrueFoundryClient } from "../../src/Client";
import { mockServerPool } from "../mock-server/MockServerPool";

describe("TracesClient", () => {
    test("query_spans", async () => {
        const server = mockServerPool.createServer();
        const client = new TrueFoundryClient({ maxRetries: 0, apiKey: "test", environment: server.baseUrl });
        const rawRequestBody = { startTime: "startTime", tracingProjectFqn: "tracingProjectFqn" };
        const rawRequestBodyWithToken = { startTime: "startTime", tracingProjectFqn: "tracingProjectFqn", pageToken: "nextPageToken" };
        const rawResponseBody = {
            data: [
                {
                    spanId: "spanId",
                    traceId: "traceId",
                    parentSpanId: "parentSpanId",
                    serviceName: "serviceName",
                    spanName: "spanName",
                    spanKind: "spanKind",
                    scopeName: "scopeName",
                    scopeVersion: "scopeVersion",
                    timestamp: "timestamp",
                    durationNs: 1.1,
                    statusCode: "statusCode",
                    statusMessage: "statusMessage",
                    spanAttributes: { key: "value" },
                    events: [{ key: "value" }],
                    createdBySubject: { subjectId: "subjectId", subjectType: "user" },
                },
            ],
            pagination: { limit: 10, nextPageToken: "nextPageToken", previousPageToken: "previousPageToken" },
        };
        // Register the specific handler first (with pageToken, strict matching)
        server
            .mockEndpoint({ once: false })
            .post("/api/svc/v1/spans/query")
            .jsonBody(rawRequestBodyWithToken, false)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();
        // Then register the general handler (without pageToken, allows extra fields)
        server
            .mockEndpoint({ once: false })
            .post("/api/svc/v1/spans/query")
            .jsonBody(rawRequestBody, true)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const expected = {
            data: [
                {
                    spanId: "spanId",
                    traceId: "traceId",
                    parentSpanId: "parentSpanId",
                    serviceName: "serviceName",
                    spanName: "spanName",
                    spanKind: "spanKind",
                    scopeName: "scopeName",
                    scopeVersion: "scopeVersion",
                    timestamp: "timestamp",
                    durationNs: 1.1,
                    statusCode: "statusCode",
                    statusMessage: "statusMessage",
                    spanAttributes: {
                        key: "value",
                    },
                    events: [
                        {
                            key: "value",
                        },
                    ],
                    createdBySubject: {
                        subjectId: "subjectId",
                        subjectType: "user",
                    },
                },
            ],
            pagination: {
                limit: 10,
                nextPageToken: "nextPageToken",
                previousPageToken: "previousPageToken",
            },
        };
        const page = await client.traces.querySpans({
            startTime: "startTime",
            tracingProjectFqn: "tracingProjectFqn",
        });

        expect(expected.data).toEqual(page.data);
        expect(page.hasNextPage()).toBe(true);
        const nextPage = await page.getNextPage();
        expect(expected.data).toEqual(nextPage.data);
    });
});
